#!/Applications/Develop/Mathematica.app/Contents/MacOS/MathematicaScript-script 

Clear["Global`*"]
thisfolder="replacethistext;
rootfolder=StringSplit[thisfolder,"/"][[1;;Length[StringSplit[thisfolder,"/"]]-1]];
rootfolder=StringJoin[StringJoin[Flatten[Table[{"/",rootfolder[[j]]},{j,1,Length[rootfolder]}]]],"/"];
model=Import[StringJoin[thisfolder,"main_output.jam"],"Table"];
data=Import[StringJoin[thisfolder,"seriesP.jam"],"Table"];
model=Table[{model[[i,1]],model[[i,2]],model[[i,3]],data[[i,4]],model[[i,4]]},{i,1,Length[model]}];
epochs=Union[model[[All,4]]];
OOTs=Table[Max[Select[model,#[[4]]==epochs[[i]]&][[All,5]]],{i,1,Length[epochs]}];
j=0;Label[jloop];j=j+1;Subscript[mini, j]=Select[model,#[[4]]==epochs[[j]]&];If[j<Length[epochs],Goto[jloop]];
temp=Flatten[Import[StringJoin[thisfolder,"bestmode.jam"],"Table"]];
Pdays=temp[[4]];
\[Tau]0=temp[[5]];
Msptrue=temp[[13]];
strue=temp[[14]]* temp[[1]];
T14=temp[[15]];
T23=temp[[16]];West=(T14+T23)/2;
xwidth=Max[Table[Max[Subscript[mini, j][[All,1]]]-Min[Subscript[mini, j][[All,1]]],{j,1,Length[epochs]}]];
yrange={Min[Table[Min[Subscript[mini, j][[All,5]]],{j,1,Length[epochs]}]],1};
yrange={yrange[[1]]-0.05(yrange[[2]]-yrange[[1]]),yrange[[2]]+0.05(yrange[[2]]-yrange[[1]])};
yrange={1-2strue^2,1};
yrange={yrange[[1]]-0.05(yrange[[2]]-yrange[[1]]),yrange[[2]]+0.05(yrange[[2]]-yrange[[1]])};
tmids=Table[Pdays Round[(Median[Subscript[mini, j][[All,1]]]-\[Tau]0)/Pdays]+\[Tau]0,{j,1,Length[epochs]}];
Clear[Msp];
rootfolder=StringSplit[thisfolder,"/"][[1;;Length[StringSplit[thisfolder,"/"]]-1]];
rootfolder=StringJoin[StringJoin[Flatten[Table[{"/",rootfolder[[j]]},{j,1,Length[rootfolder]}]]],"/"];
model=Import[StringJoin[thisfolder,"ghost_output.jam"],"Table"];
data=Import[StringJoin[thisfolder,"seriesP.jam"],"Table"];
model=Table[{model[[i,1]],model[[i,2]],model[[i,3]],data[[i,4]],model[[i,4]]},{i,1,Length[model]}];
epochs=Union[model[[All,4]]];
OOTs=Table[Max[Select[model,#[[4]]==epochs[[i]]&][[All,5]]],{i,1,Length[epochs]}];
j=0;Label[jloop];j=j+1;Subscript[gini, j]=Select[model,#[[4]]==epochs[[j]]&];Subscript[tmiddy, j]=Sum[Subscript[gini, j][[i,1]](Subscript[gini, j][[i,5]]-1),{i,1,Length[Subscript[gini, j]]}]/Sum[(Subscript[gini, j][[i,5]]-1),{i,1,Length[Subscript[gini, j]]}];Subscript[ttv, j]=Subscript[tmiddy, j]-Pdays Round[(Median[Subscript[gini, j][[All,1]]]-\[Tau]0)/Pdays]-\[Tau]0;Subscript[ttvmoon, j]=Subscript[tmiddy, j]-(1/Msp)Subscript[ttv, j];If[j<Length[epochs],Goto[jloop]];
outofplantimes=Select[Flatten[Table[Table[Subscript[gini, j][[i,{1,5}]],{i,1,Length[Subscript[gini, j]]}],{j,1,Length[epochs]}],1],!(#[[2]]<1)&][[All,1]];
temp2=Flatten[Table[Table[{Subscript[mini, j][[i,1]],Subscript[mini, j][[i,5]]-Subscript[gini, j][[i,5]]},{i,1,Length[Subscript[mini, j]]}],{j,1,Length[epochs]}],1];
temp2=Select[temp2,MemberQ[outofplantimes,#[[1]]]&];
\[CapitalDelta]\[Chi]2theoretical=Sum[(temp2[[i,2]]/\[CapitalDelta])^2,{i,1,Length[temp2]}];
ttvtab=Table[{j,Subscript[tmiddy, j],Subscript[ttv, j]},{j,1,Length[epochs]}];
Export[StringJoin[thisfolder,"ttv.dat"],ttvtab,"Table"];
Mspgrid=Table[10^x,{x,-3,0,0.01}];
k=0;Label[kloop];k=k+1;j=0;Label[jloop];j=j+1;Subscript[outplan, j]=Select[Subscript[mini, j][[All,{1,5}]],!(Subscript[tmiddy, j]-0.51T14<#[[1]]<Subscript[tmiddy, j]+0.51T14)&];Subscript[inmoon, j]=Select[Subscript[outplan, j],((Subscript[ttvmoon, j]/.Msp->Mspgrid[[k]])-0.5West<#[[1]]<(Subscript[ttvmoon, j]/.Msp->Mspgrid[[k]])+0.5West)&];Subscript[outmoon, j]=Select[Subscript[outplan, j],!((Subscript[ttvmoon, j]/.Msp->Mspgrid[[k]])-0.5West<#[[1]]<(Subscript[ttvmoon, j]/.Msp->Mspgrid[[k]])+0.5West)&];If[j<Length[epochs],Goto[jloop]];inmoonall=Flatten[Table[Subscript[inmoon, j],{j,1,Length[epochs]}],1];outmoonall=Flatten[Table[Subscript[outmoon, j],{j,1,Length[epochs]}],1];outplanall=Flatten[Table[Subscript[outplan, j],{j,1,Length[epochs]}],1];\[Mu]inmoon=Mean[inmoonall[[All,2]]];\[Mu]outmoon=Mean[outmoonall[[All,2]]];\[Mu]outplan=Mean[outplanall[[All,2]]];Subscript[\[Delta], k]=\[Mu]outmoon-\[Mu]inmoon;\[Chi]2null=Sum[((inmoonall[[i,2]]-\[Mu]outplan)/\[CapitalDelta])^2,{i,1,Length[inmoonall]}]+Sum[((outmoonall[[i,2]]-\[Mu]outplan)/\[CapitalDelta])^2,{i,1,Length[outmoonall]}];\[Chi]2moon=Sum[((inmoonall[[i,2]]-\[Mu]inmoon)/\[CapitalDelta])^2,{i,1,Length[inmoonall]}]+Sum[((outmoonall[[i,2]]-\[Mu]outmoon)/\[CapitalDelta])^2,{i,1,Length[outmoonall]}];Subscript[\[CapitalDelta]\[Chi]2, k]=(\[Chi]2null-\[Chi]2moon);If[k<Length[Mspgrid],Goto[kloop]];
result=Table[{Mspgrid[[k]],Subscript[\[Delta], k],Subscript[\[CapitalDelta]\[Chi]2, k],Simplify[Subscript[\[CapitalDelta]\[Chi]2, k]/\[CapitalDelta]\[Chi]2theoretical]},{k,1,Length[Mspgrid]}];
temp=result;
temp=Table[{temp[[i,1]],temp[[i,2]],temp[[i,2]]/strue^2,temp[[i,3]]/.\[CapitalDelta]->10^(-3),temp[[i,4]]},{i,1,Length[temp]}];
temp=Select[temp,NumberQ[#[[2]]]&];
Export[StringJoin[thisfolder,"Msp_grid.dat"],temp,"Table"];
Mspbestfit=Select[result,#[[4]]==Max[result[[All,4]]]&][[1,1]];
height=Select[result,#[[4]]==Max[result[[All,4]]]&][[1,4]];
temp=Select[result,#[[1]]<Mspbestfit&&#[[4]]<0.5height&];
Mspbestfitlow=Select[temp,#[[4]]==Max[temp[[All,4]]]&][[1,1]];
temp=Select[result,#[[1]]>Mspbestfit&&#[[4]]<0.5height&];
Mspbestfithigh=Select[temp,#[[4]]==Max[temp[[All,4]]]&][[1,1]];
j=0;Label[jloop];j=j+1;Subscript[inmoon, j]=Select[Subscript[mini, j][[All,{1,5}]],((Subscript[ttvmoon, j]/.Msp->Mspbestfit)-0.5West<#[[1]]<(Subscript[ttvmoon, j]/.Msp->Mspbestfit)+0.5West)&&!(Subscript[tmiddy, j]-0.51T14<#[[1]]<Subscript[tmiddy, j]+0.51T14)&];Subscript[inmoon, j]=Table[{(Subscript[inmoon, j][[i,1]]-(Subscript[ttvmoon, j]/.Msp->Mspbestfit))/West,Subscript[inmoon, j][[i,2]]},{i,1,Length[Subscript[inmoon, j]]}];Subscript[outmoon, j]=Select[Subscript[mini, j][[All,{1,5}]],!((Subscript[ttvmoon, j]/.Msp->Mspbestfit)-0.5West<#[[1]]<(Subscript[ttvmoon, j]/.Msp->Mspbestfit)+0.5West)&&!(Subscript[tmiddy, j]-0.51T14<#[[1]]<Subscript[tmiddy, j]+0.51T14)&];Subscript[outmoon, j]=Table[{(Subscript[outmoon, j][[i,1]]-(Subscript[ttvmoon, j]/.Msp->Mspbestfit))/West,Subscript[outmoon, j][[i,2]]},{i,1,Length[Subscript[outmoon, j]]}];Subscript[outplan, j]=Select[Subscript[mini, j][[All,{1,5}]],!(Subscript[tmiddy, j]-0.51T14<#[[1]]<Subscript[tmiddy, j]+0.51T14)&];If[j<Length[epochs],Goto[jloop]];inmoonall=Flatten[Table[Subscript[inmoon, j],{j,1,Length[epochs]}],1];outmoonall=Flatten[Table[Subscript[outmoon, j],{j,1,Length[epochs]}],1];outplanall=Flatten[Table[Subscript[outplan, j],{j,1,Length[epochs]}],1];
\[Mu]inmoon=Mean[inmoonall[[All,2]]];\[Mu]outmoon=Mean[outmoonall[[All,2]]];\[Mu]outplan=Mean[outplanall[[All,2]]];\[Delta]best=\[Mu]outmoon-\[Mu]inmoon;\[Chi]2null=Sum[((inmoonall[[i,2]]-\[Mu]outplan)/\[CapitalDelta])^2,{i,1,Length[inmoonall]}]+Sum[((outmoonall[[i,2]]-\[Mu]outplan)/\[CapitalDelta])^2,{i,1,Length[outmoonall]}];\[Chi]2moon=Sum[((inmoonall[[i,2]]-\[Mu]inmoon)/\[CapitalDelta])^2,{i,1,Length[inmoonall]}]+Sum[((outmoonall[[i,2]]-\[Mu]outmoon)/\[CapitalDelta])^2,{i,1,Length[outmoonall]}];\[CapitalDelta]\[Chi]2best=(\[Chi]2null-\[Chi]2moon);
\[CapitalDelta]0=1000*10^(-6);
Export[StringJoin[thisfolder,"chi2_scales.jam"],{N[\[CapitalDelta]0],Sqrt[\[CapitalDelta]\[Chi]2best/.\[CapitalDelta]->\[CapitalDelta]0],Sqrt[\[CapitalDelta]\[Chi]2theoretical/.\[CapitalDelta]->\[CapitalDelta]0]},"Table"];
inmoonallnoise=Sort[Table[{inmoonall[[i,1]],10^6(RandomReal[NormalDistribution[inmoonall[[i,2]],\[CapitalDelta]0]]-1)},{i,1,Length[inmoonall]}]];
outmoonallnoise=Sort[Table[{outmoonall[[i,1]],10^6(RandomReal[NormalDistribution[outmoonall[[i,2]],\[CapitalDelta]0]]-1)},{i,1,Length[outmoonall]}]];
tbin=0.1;
ttmin=Floor[Min[outmoonallnoise[[All,1]]],tbin];
ttmax=Ceiling[Max[outmoonallnoise[[All,1]]],tbin];
datain=Sort[Join[inmoonallnoise,outmoonallnoise]];
j=0;Label[jloop];j=j+1;tab=Select[datain,ttmin+(j-1)tbin<#[[1]]<ttmin+j tbin&];Subscript[\[Alpha], j]={ttmin+(j-0.5)tbin,Mean[tab[[All,2]]],StandardDeviation[tab[[All,2]]]/Sqrt[Length[tab]-1]};If[ttmin+j tbin<ttmax,Goto[jloop]];
binned=Table[Subscript[\[Alpha], jj],{jj,1,j}];
binned=Select[binned,NumberQ[#[[2]]]&&NumberQ[#[[3]]]&];
<<ErrorBarPlots`
fn[\[Delta]_,t14_,t23_,t_]:=Piecewise[{{0,Abs[t]>0.5t14},{-\[Delta],Abs[t]<0.5t23},{(2 (1 + \[Delta]))/( t14- t23) t-((t23+ t14 \[Delta])/( t14-t23)),0.5t23<t<0.5t14},{-((2 (1 + \[Delta]))/( t14- t23))t-((t23+ t14 \[Delta])/( t14-t23)),-0.5t14<t<-0.5t23}}];
xrange2={-2.5,2.5};
yrange2={10^6(-0.2\[CapitalDelta]0-1.0strue^2),0.2 10^6 \[CapitalDelta]0};
test1=Select[inmoonallnoise,xrange2[[1]]<#[[1]]<xrange2[[2]]&&yrange2[[1]]<#[[2]]<yrange2[[2]]&];
test2=Select[outmoonallnoise,xrange2[[1]]<#[[1]]<xrange2[[2]]&&yrange2[[1]]<#[[2]]<yrange2[[2]]&];
truefold=Show[ListPlot[{test1,test2},PlotStyle->{Directive[Gray,Opacity[0.66]],Directive[Gray,Opacity[0.66]]},PlotRange->{xrange2,yrange2},Frame->True,ImageSize->Large,AspectRatio->0.4,Axes->None,BaseStyle->{FontFamily->"CMU Serif",FontSize->20}],ErrorListPlot[binned[[All,{1,2,3}]],PlotStyle->Black],Plot[fn[\[Delta]best*10^6,T14/West,T23/West,t],{t,-2.5,2.5},Exclusions->None,PlotStyle->Directive[Lighter[Black],Thickness[0.004]]]];
Export[StringJoin[thisfolder,"fold.pdf"],truefold];